{% extends "base.html" %}
{% block content %}
<h2>Друзья</h2>

<h3>Ваши друзья</h3>
<ul class="list" id="friends">
{% for f in friends %}
  <li>
    {{ f.other_login }}
    <span style="float:right;display:flex;gap:8px">
      <button class="btn invite-btn" data-id="{{ f.other_id }}">Пригласить</button>
      <a class="btn" href="/accounts/friends/remove/{{ f.other_id }}/">Удалить</a>
    </span>
  </li>
{% empty %}<li>Нет друзей</li>{% endfor %}
</ul>

<h3>Заявки</h3>
<ul class="list">
{% for r in requests %}
  <li>{{ r.from_login }} —
    <a class="btn" href="/accounts/friends/accept/{{ r.from_id }}/">Принять</a>
    <a class="btn" href="/accounts/friends/decline/{{ r.from_id }}/">Отклонить</a>
  </li>
{% empty %}<li>Нет заявок</li>{% endfor %}
</ul>

<form method="post" action="/accounts/friends/add/" class="form">
  {% csrf_token %}
  <div class="field"><label>Никнейм</label><input name="login" required placeholder="Игровой ник"></div>
  <button class="btn" type="submit">Добавить</button>
</form>

<script>
document.querySelectorAll('.invite-btn').forEach(btn=>{
  btn.onclick = async ()=>{
    const uid = btn.dataset.id;
    try{
      const res = await api(`/match/invite_ajax/${uid}/`);
      if(res.ok){
        const token = res.token;
        showWaiting('Ожидаем ответ соперника...', async ()=>{
          await api(`/match/invite/${token}/cancel/`);
        }, token);
      }
    }catch(e){ alert('Не удалось отправить приглашение'); }
  };
});
</script>
{% endblock %}