{% extends "base.html" %}
{% block content %}
<h2>Игра {{ game.code }}</h2>
<div class="hud">
  <div class="tag">Ход: <span id="turn">--</span></div>
  <div class="tag">Таймер: <span id="timer">--</span> сек</div>
  <div class="tag">Банк: <span id="bank">--</span> сек</div>
</div>
<div id="setupBar" class="toolbar" style="display:none;margin-top:8px">
  <span class="tag">Расстановка:</span>
  <button class="btn" id="btnAuto">Сгенерировать расстановку</button>
  <button class="btn" id="btnReady">Готов</button>
</div>
<div class="toolbar" style="margin-top:8px">
  <span class="tag">Режим:</span>
  <button class="btn" data-mode="move">Ход</button>
  <button class="btn" data-mode="torpedo">Торпеда</button>
  <button class="btn" data-mode="air">Самолёт</button>
  <button class="btn" data-mode="bomb">Атомная</button>
  <button class="btn btn-danger" id="btnResign">Сдаться</button>
</div>
<div class="board-wrap">
  <div id="board" class="board" data-game="{{ game.id }}" data-side="{{ side }}"></div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const elBoard=document.getElementById('board');
  const gameId=elBoard.dataset.game;
  const me=parseInt(elBoard.dataset.side);
  let state=null, mode='move', sel=null, sel2=null;

  document.querySelectorAll('.toolbar .btn').forEach(b=>{
    if(b.dataset.mode) b.onclick=()=>{ mode=b.dataset.mode; sel=null; sel2=null; };
  });

  async function refresh(){
    try{
      const d = await api(`/game/state/${gameId}/`);
      state=d.state; document.getElementById('turn').textContent=(state.turn===1?'Игрок 1':'Игрок 2');
      draw();
      document.getElementById('setupBar').style.display = (state.phase==='SETUP') ? 'flex' : 'none';
    }catch(e){}
  }

  function draw(){
    if(!state) return;
    const rows=15, cols=14;
    elBoard.innerHTML=''; elBoard.style.setProperty('--rows', rows); elBoard.style.setProperty('--cols', cols);
    const board=state.board||{}; const key=(x,y)=>`${x},${y}`;
    for(let y=0;y<rows;y++){
      for(let x=0;x<cols;x++){
        const vx=x, vy=(me===1?y:(rows-1-y));
        const cell=document.createElement('div'); cell.className='cell'; cell.dataset.x=vx; cell.dataset.y=vy;
        const stack=board[key(vx,vy)]||[];
        if(stack.length){
          const p=stack[0]; const span=document.createElement('span');
          span.textContent=p.kind; span.className=`piece owner${p.owner} kind${p.kind}`;
          cell.appendChild(span);
        }
        elBoard.appendChild(cell);
      }
    }
  }

  elBoard.addEventListener('click', async e=>{
    const c=e.target.closest('.cell'); if(!c||!state) return;
    const xy=[parseInt(c.dataset.x), parseInt(c.dataset.y)];
    if(state.phase==='SETUP') return;
    try{
      if(mode==='move'){
        if(!sel){ sel=xy; c.classList.add('sel'); return; }
        const src=sel; sel=null;
        const res = await api(`/game/move/${gameId}/`,'POST',{src, dst:xy});
        if(res.state){ state=res.state; draw(); }
      }else if(mode==='torpedo'){
        if(!sel){ sel=xy; c.classList.add('sel'); return; }
        if(!sel2){
          sel2=xy; c.classList.add('sel');
          const d=prompt('Направление: dx,dy (например 1,0; 0,-1; -1,0; 1,1 и т.д.)'); if(!d){ sel=null; sel2=null; draw(); return; }
          const [dx,dy]=d.split(',').map(Number);
          const res = await api(`/game/torpedo/${gameId}/`,'POST',{t:sel, tk:sel2, dir:[dx,dy]});
          sel=null; sel2=null; if(res.state){ state=res.state; draw(); }
        }
      }else if(mode==='air'){
        if(!sel){ sel=xy; c.classList.add('sel'); return; }
        const res = await api(`/game/air/${gameId}/`,'POST',{a:sel, s:xy});
        sel=null; if(res.state){ state=res.state; draw(); }
      }else if(mode==='bomb'){
        const res = await api(`/game/bomb/${gameId}/`,'POST',{ab:xy});
        if(res.state){ state=res.state; draw(); }
      }
    }catch(err){ console.error(err); }
  });

  document.getElementById('btnAuto').onclick = async ()=>{ await api(`/game/autosetup/${gameId}/`,'POST',{}); refresh(); };
  document.getElementById('btnReady').onclick = async ()=>{ await api(`/game/submit_setup/${gameId}/`,'POST',{}); refresh(); };
  document.getElementById('btnResign').onclick=()=> api(`/game/resign/${gameId}/`,'POST',{}).then(refresh);

  refresh(); setInterval(refresh, 2000);
});
</script>
{% endblock %}